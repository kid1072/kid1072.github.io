<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>星海引路人 - 拓客社团ME部门招新游戏</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script>
        // 配置Tailwind自定义颜色
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#89A707',
                        secondary: '#FFCA00',
                        neutral: '#E4EAE7',
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
        }
    </style>
</head>
<body class="bg-white font-sans text-gray-800">
    <div id="game-container" class="max-w-md mx-4 mx-auto bg-white p-6 rounded-xl shadow-lg mt-4 mb-8">
        <!-- 标题页 -->
        <div id="title-screen" class="text-center py-6">
            <div class="w-20 h-20 bg-primary rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fa fa-star text-white text-3xl"></i>
            </div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">星海引路人</h1>
            <p class="text-gray-600 mb-8">拓客社团ME关爱教育部门招新互动游戏</p>
            <button id="start-btn" class="bg-primary hover:bg-primary/90 text-white font-medium py-3 px-8 rounded-lg transition duration-300 transform hover:scale-105">
                开始游戏 <i class="fa fa-arrow-right ml-2 text-white"></i>
            </button>
        </div>

        <!-- 游戏主界面 -->
        <div id="game-screen" class="hidden rounded-lg p-4">
            <div class="mb-4 pb-4 border-b border-primary/20">
                <div class="flex items-center text-sm text-gray-500 mb-2">
                    <i class="fa fa-map-marker mr-2"></i>
                    <span id="progress-indicator">当前进度</span>
                </div>
                <div id="scene-container" class="text-lg leading-relaxed"></div>
            </div>
            <div id="choices-container" class="space-y-3"></div>
        </div>

        <!-- 结局页 -->
        <div id="ending-screen" class="hidden">
            <div id="screenshot-container">
                <!-- 用于生成分享图片的容器 -->
                <div id="share-image-container" class="bg-white rounded-xl p-6 mb-6">
                    <div class="w-20 h-20 bg-primary rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fa fa-star text-white text-3xl"></i>
                    </div>
                    <h2 id="ending-title" class="text-2xl font-bold mb-4 text-center"></h2>
                    <p id="ending-desc" class="text-gray-700 mb-6 leading-relaxed"></p>
                    <p id="ending-relation" class="font-semibold text-primary mb-6 text-center"></p>
                    <div class="text-center text-sm text-gray-500 mt-6 pt-4 border-t border-gray-200">
                        来自拓客社团「星海引路人」ME部门招新游戏
                    </div>
                </div>

                <!-- 招新说明部分 -->
                <div class="bg-neutral p-5 rounded-lg mb-6">
                    <h3 class="text-xl font-bold text-primary mb-3">关于 ME 关爱教育部门</h3>
                    <p class="text-gray-700 mb-3">
                        我们关注偏远地区、少数群体、社会边缘群体的教育发展和身心健康，致力于改善社会资源不均的现状。通过线上陪伴指导（如蓝信封、太阳语、星云计划等）和线下支教，让更多孩子感受到教育与陪伴的力量。
                    </p>
                    <p class="text-gray-700 italic mb-4">
                        "我们相信：用一棵树摇动另一棵树，用一朵云推动另一朵云，用一个灵魂唤醒另一个灵魂。"
                    </p>
                    <p class="text-primary font-bold mb-4">期待你的加入！</p>

                    <!-- 招新推送链接按钮 -->
                    <a href="https://example.com/me-recruitment" target="_blank" class="inline-block bg-primary hover:bg-primary/90 text-white font-medium py-2 px-6 rounded-lg transition duration-300 transform hover:scale-105">
                        <i class="fa fa-link mr-2"></i> 查看招新详情
                    </a>
                </div>
            </div>

            <!-- 分享按钮 -->
            <button id="share-btn" class="w-full bg-secondary hover:bg-secondary/90 text-gray-800 font-medium py-3 px-4 rounded-lg transition duration-300 mb-3">
                <i class="fa fa-share-alt mr-2"></i> 保存结果图片
            </button>
            <p class="text-xs text-gray-500 text-center mt-0 mb-3">
                若无法保存，请尝试截图
            </p>
            <button id="restart-btn" class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-3 px-4 rounded-lg transition duration-300">
                <i class="fa fa-refresh mr-2"></i> 重新开始
            </button>
        </div>
    </div>

    <script>
        // --- 游戏核心逻辑 ---
        const gameData = {
            scenes: {
                // 此处省略场景数据（保持原有内容）
                sunshine_18: {
                    text: "调整目标后，小远成功完成了任务，他学会了灵活面对困难。",
                    choices: [
                        { text: "肯定他的成长，讨论如何设定合理目标。", next: "ending_good_teacher", path: "C1a2a1" },
                        { text: "鼓励他以后遇到类似情况时，尝试自己调整。", next: "ending_independent_learner", path: "C1a2a2" }
                    ]
                },
                sunshine_19: {
                    text: "经过多次尝试和方法调整，小远终于完成了任务。",
                    choices: [
                        { text: "帮他总结成功经验，形成自己的解决问题模式。", next: "ending_independent_learner", path: "C1a2b1" },
                        { text: "庆祝他的成功，给予适当奖励。", next: "ending_A_success", path: "C1a2b2" }
                    ]
                },
                sunshine_20: {
                    text: "小远的天文报告获得了专业人士的肯定，他非常开心。",
                    choices: [
                        // 此处省略更多场景数据
                    ]
                }
            },
            endings: {
                ending_A_success: {
                    title: "文化传承者",
                    desc: "你成功帮助学生在文化学习和个人成长之间找到了平衡，既保护了他们的兴趣，又促进了全面发展。",
                    relation: "ME部门的文化教育项目需要你的经验"
                },
                ending_A_excellent: {
                    title: "教育创新者",
                    desc: "你不仅完成了教学任务，更创造了独特的教学方法，让学生实现了跨越式成长，是教育领域的创新典范。",
                    relation: "ME部门的课程研发团队期待你的加入"
                },
                ending_good_teacher: {
                    title: "心灵引路人",
                    desc: "你用耐心和关怀赢得了学生的信任，成为了他们成长道路上的重要支持者，展现了教育者最珍贵的品质。",
                    relation: "ME部门的陪伴计划适合你的特质"
                },
                ending_independent_learner: {
                    title: "能力培养者",
                    desc: "你成功地教会了他如何自己学习，这是一种更长久的陪伴。真正的教育，是让学生在没有你的时候，依然能自信地探索世界。",
                    relation: "对应项目：【太阳语计划】"
                },
                ending_project_pioneer: {
                    title: "项目开拓者",
                    desc: "你不仅完成了基础教学任务，更开拓了新的教学模式，为项目发展做出了突破性贡献。你的创新思维和执行力让更多人受益。",
                    relation: "ME部门需要你这样的创新者"
                },
                ending_community_builder: {
                    title: "社区建设者",
                    desc: "你成功连接了多方资源，在帮助个体的同时推动了社区发展，形成了可持续的互助模式，展现了强大的协调能力。",
                    relation: "ME部门的社区项目等待你的加入"
                }
            }
        };

        // 游戏状态管理
        const gameState = {
            currentScene: 'start',
            path: []
        };

        // DOM 元素
        const titleScreen = document.getElementById('title-screen');
        const gameScreen = document.getElementById('game-screen');
        const endingScreen = document.getElementById('ending-screen');
        const startBtn = document.getElementById('start-btn');
        const restartBtn = document.getElementById('restart-btn');
        const shareBtn = document.getElementById('share-btn');
        const sceneContainer = document.getElementById('scene-container');
        const choicesContainer = document.getElementById('choices-container');
        const progressIndicator = document.getElementById('progress-indicator');
        const endingTitle = document.getElementById('ending-title');
        const endingDesc = document.getElementById('ending-desc');
        const endingRelation = document.getElementById('ending-relation');
        const shareImageContainer = document.getElementById('share-image-container');
        const screenshotContainer = document.getElementById('screenshot-container');

        // 初始化游戏
        function initGame() {
            startBtn.addEventListener('click', startGame);
            restartBtn.addEventListener('click', restartGame);
            shareBtn.addEventListener('click', generateShareImage);
        }

        // 开始游戏
        function startGame() {
            titleScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            loadScene('start');
        }

        // 重新开始
        function restartGame() {
            gameState.currentScene = 'start';
            gameState.path = [];
            endingScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            loadScene('start');
        }

        // 加载场景
        function loadScene(sceneId) {
            const scene = gameData.scenes[sceneId];
            if (!scene) return;

            gameState.currentScene = sceneId;
            
            // 更新场景文本
            sceneContainer.textContent = scene.text;
            
            // 更新进度指示器
            progressIndicator.textContent = `路径: ${gameState.path.join(' > ')}`;
            
            // 渲染选项
            choicesContainer.innerHTML = '';
            if (scene.choices) {
                scene.choices.forEach(choice => {
                    const button = document.createElement('button');
                    button.className = 'w-full bg-primary/10 hover:bg-primary/20 text-gray-800 font-medium py-3 px-4 rounded-lg transition duration-300 text-left';
                    button.textContent = choice.text;
                    button.addEventListener('click', () => {
                        // 记录路径
                        if (choice.path) {
                            gameState.path.push(choice.path);
                        }
                        // 检查是否是结局
                        if (choice.next.startsWith('ending_')) {
                            showEnding(choice.next);
                        } else {
                            loadScene(choice.next);
                        }
                    });
                    choicesContainer.appendChild(button);
                });
            }
        }

        // 显示结局
        function showEnding(endingId) {
            const ending = gameData.endings[endingId];
            if (!ending) return;
            
            endingTitle.textContent = ending.title;
            endingDesc.textContent = ending.desc;
            endingRelation.textContent = ending.relation;
            
            gameScreen.classList.add('hidden');
            endingScreen.classList.remove('hidden');
        }

        // 生成并下载分享图片（适配各种移动浏览器）
        function generateShareImage() {
            // 显示加载状态，防止重复点击
            const originalText = shareBtn.innerHTML;
            shareBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i> 生成中...';
            shareBtn.disabled = true;

            // 限制图片容器尺寸，适配移动设备
            const container = document.getElementById('screenshot-container');
            const originalWidth = container.style.maxWidth;
            container.style.maxWidth = '360px';

            html2canvas(container, {
                backgroundColor: null,
                scale: window.devicePixelRatio || 2, // 自适应设备像素比
                useCORS: true,
                logging: false
            }).then(canvas => {
                container.style.maxWidth = originalWidth;

                // 延迟处理确保canvas绘制完成
                setTimeout(() => {
                    try {
                        const dataUrl = canvas.toDataURL('image/png');
                        saveImageOnMobile(dataUrl);

                        // 恢复按钮状态
                        setTimeout(() => {
                            shareBtn.innerHTML = originalText;
                            shareBtn.disabled = false;
                        }, 1000);
                    } catch (err) {
                        handleSaveError(originalText, err);
                    }
                }, 500);
            }).catch(err => {
                handleSaveError(originalText, err);
            });
        }

        // 错误处理函数
        function handleSaveError(originalText, err) {
            console.error('生成图片失败:', err);
            shareBtn.innerHTML = originalText;
            shareBtn.disabled = false;
            alert('保存失败，请尝试截图分享');
        }

        // 适配移动浏览器的图片保存方法
        function saveImageOnMobile(dataUrl) {
            const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);
            const isWeChat = /MicroMessenger/.test(navigator.userAgent);

            // 微信浏览器特殊处理（不支持直接下载）
            if (isWeChat) {
                alert('请长按图片选择"保存图片"');
                // 创建临时图片预览
                const tempImg = document.createElement('img');
                tempImg.src = dataUrl;
                tempImg.className = 'fixed top-0 left-0 w-full h-full z-50 object-contain bg-white p-4';
                tempImg.style.boxSizing = 'border-box';
                tempImg.onclick = () => document.body.removeChild(tempImg);
                document.body.appendChild(tempImg);
                return;
            }

            // Safari浏览器处理（需通过新建页面打开）
            if (isSafari) {
                const newTab = window.open();
                newTab.document.write(`<html><head><title>星海引路人-我的结局</title></head><body style="margin:0;"><img src="${dataUrl}" style="max-width:100%;"/></body></html>`);
                newTab.document.close();
                setTimeout(() => {
                    alert('请长按图片选择"保存图片"');
                }, 500);
                return;
            }

            // 通用处理
            const link = document.createElement('a');
            link.download = '星海引路人-我的结局.png';
            link.href = dataUrl;
            link.style.display = 'none';
            document.body.appendChild(link);

            // 模拟触摸点击（适配移动设备）
            const event = new MouseEvent('click', {
                view: window,
                bubbles: true,
                cancelable: true
            });
            link.dispatchEvent(event);

            setTimeout(() => {
                document.body.removeChild(link);
                alert('图片已保存，快去分享到朋友圈吧！');
            }, 1000);
        }

        // 启动游戏
        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>